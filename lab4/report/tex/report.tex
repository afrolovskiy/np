\documentclass[a4paper,12pt]{article}

\input{header.tex}

\title{Отчёт по лабораторной работе \\ <<Локальные сети>>}
\author{Фроловский Алексей Вадимлвич}

\begin{document}

\maketitle

\tableofcontents

% Текст отчёта должен быть читаемым!!! Написанное здесь является рыбой.

\section{Получение адреса по DHCP}

Получение "случайного" адреса можно продемонстрировать на примере
сети \textbf{lan2} с адресом \textbf{10.102.0.0/16}. Для этого
необходимо настроить службу DHCP на маршрутизаторе \textbf{r2}:
в файле \textbf{/etc/dhcp3/dhcpd.conf} следует указать следующие
настройки:
\begin{Verbatim}
subnet 172.16.0.0 netmask 255.255.0.0 \{\}

subnet 10.102.0.0 netmask 255.255.0.0
\{
  range 10.102.0.2 10.102.0.200;
  option routers 10.102.0.1;
  option domain-name-servers 192.168.0.1;
\}
\end{Verbatim}

Отметим, что в настройке \textbf{range} указывается диапазон,
в котором будут динамически выдаваться ip-адреса, в
\textbf{option routers} - ip-адреса маршрутизаторов сети,
\textbf{option domain-name-servers} - ip-адреса DNS-серверов.

Выполним на маршрутизаторе \textbf{r2}:
\begin{Verbatim}
tcpdump -tnv -i eth0 udp
\end{Verbatim}

Получим следующий вывод:
\begin{Verbatim}
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0x82701421, Flags [none]
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.102.0.1.67 > 10.102.0.2.68: BOOTP/DHCP, Reply, length 300, xid 0x82701421, Flags [none]
          Your-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0x82701421, Flags [none]
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.102.0.1.67 > 10.102.0.2.68: BOOTP/DHCP, Reply, length 300, xid 0x82701421, Flags [none]
          Your-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 328) 
	10.102.0.2.68 > 10.102.0.1.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0x7185b80d, Flags [none]
          Client-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0xe433c82b, Flags [none]
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.102.0.1.67 > 10.102.0.2.68: BOOTP/DHCP, Reply, length 300, xid 0xe433c82b, Flags [none]
          Your-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0xe433c82b, Flags [none]
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.102.0.1.67 > 10.102.0.2.68: BOOTP/DHCP, Reply, length 300, xid 0xe433c82b, Flags [none]
          Your-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
\end{Verbatim}

Получение "фиксированных" адресов можно продемонстрировать на
примере сети \textbf{lan1} с адресом \textbf{10.0.0.0/16}. Для
этого необходимо настроить службу DHCP на маршрутизаторе
\textbf{r1}: в файле \textbf{/etc/dhcp3/dhcpd.conf} следует
указать следующие настройки:
\begin{Verbatim}
subnet 172.16.0.0 netmask 255.255.0.0 \{\}

subnet 10.0.0.0 netmask 255.255.0.0
\{
  range 10.0.0.2 10.0.10.200;
  option routers 10.0.0.1;
  option domain-name-servers 192.168.0.1;
\}

host ws11 \{
    hardware ethernet 10:10:10:10:10:BA;
    fixed-address 10.0.1.1;
\}

host ws12 \{
    hardware ethernet 10:10:10:10:10:BB;
    fixed-address 10.0.2.1;
\}

host ws13 \{
    hardware ethernet 10:10:10:10:10:BC;
    fixed-address 10.0.3.1;
\}

host s11 \{
    hardware ethernet 10:10:10:10:20:AA;
    fixed-address 10.0.4.10;
\}

host s12 \{
    hardware ethernet 10:10:10:10:20:BB;
    fixed-address 10.0.4.20;
\}
\end{Verbatim}

Выполним на маршрутизаторе \textbf{r2}:
\begin{Verbatim}
tcpdump -tnv -i eth0 udp
\end{Verbatim}

Получим следующий вывод:
\begin{Verbatim}
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:bb, 
		length 300, xid 0x28576d02, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.20.68: BOOTP/DHCP, Reply, 
		length 300, xid 0x28576d02, Flags [none]
	  Your-IP 10.0.4.20
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:bb, 
		length 300, xid 0x28576d02, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.20.68: BOOTP/DHCP, Reply, length 300, xid 0x28576d02, Flags [none]
	  Your-IP 10.0.4.20
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 328) 
	10.0.4.10.68 > 10.0.0.1.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xc48d122e, Flags [none]
	  Client-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0xad5a342d, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.1.1.68: BOOTP/DHCP, Reply, length 300, xid 0xad5a342d, Flags [none]
	  Your-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0xad5a342d, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.1.1.68: BOOTP/DHCP, Reply, length 300, xid 0xad5a342d, Flags [none]
	  Your-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0xa001b35a, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.2.1.68: BOOTP/DHCP, Reply, length 300, xid 0xa001b35a, Flags [none]
	  Your-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0xa001b35a, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.2.1.68: BOOTP/DHCP, Reply, length 300, xid 0xa001b35a, Flags [none]
	  Your-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:bb, 
		length 300, xid 0x93a8a447, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.20.68: BOOTP/DHCP, Reply, length 300, xid 0x93a8a447, Flags [none]
	  Your-IP 10.0.4.20
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:bb, 
		length 300, xid 0x93a8a447, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.20.68: BOOTP/DHCP, Reply, length 300, xid 0x93a8a447, Flags [none]
	  Your-IP 10.0.4.20
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 328) 
	10.0.1.1.68 > 10.0.0.1.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0x437a631f, Flags [none]
	  Client-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bc, 
		length 300, xid 0xecf5c126, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.3.1.68: BOOTP/DHCP, Reply, length 300, xid 0xecf5c126, Flags [none]
	  Your-IP 10.0.3.1
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bc, 
		length 300, xid 0xecf5c126, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.3.1.68: BOOTP/DHCP, Reply, length 300, xid 0xecf5c126, Flags [none]
	  Your-IP 10.0.3.1
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0x58752e33, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.1.1.68: BOOTP/DHCP, Reply, length 300, xid 0x58752e33, Flags [none]
	  Your-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0x58752e33, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.1.1.68: BOOTP/DHCP, Reply, length 300, xid 0x58752e33, Flags [none]
	  Your-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 328) 
	10.0.2.1.68 > 10.0.0.1.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0x193e306b, Flags [none]
	  Client-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0x8511b67e, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.2.1.68: BOOTP/DHCP, Reply, length 300, xid 0x8511b67e, Flags [none]
	  Your-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0x8511b67e, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.2.1.68: BOOTP/DHCP, Reply, length 300, xid 0x8511b67e, Flags [none]
	  Your-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xd215445, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.10.68: BOOTP/DHCP, Reply, length 300, xid 0xd215445, Flags [none]
	  Your-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xd215445, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.10.68: BOOTP/DHCP, Reply, length 300, xid 0xd215445, Flags [none]
	  Your-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bc, 
		length 300, xid 0x3dad9929, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.3.1.68: BOOTP/DHCP, Reply, length 300, xid 0x3dad9929, Flags [none]
	  Your-IP 10.0.3.1
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bc, 
		length 300, xid 0x3dad9929, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.3.1.68: BOOTP/DHCP, Reply, length 300, xid 0x3dad9929, Flags [none]
	  Your-IP 10.0.3.1
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xd3cd0b29, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.10.68: BOOTP/DHCP, Reply, length 300, xid 0xd3cd0b29, Flags [none]
	  Your-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xd3cd0b29, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.10.68: BOOTP/DHCP, Reply, length 300, xid 0xd3cd0b29, Flags [none]
	  Your-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
\end{Verbatim}


\section{Использование VPN}

Для создания виртуальной частной сети используется служба OpenVPN.
В качестве сервера выступает маршрутизатор \textbf{r1}, ожидающего подключение, а в качестве клиента - \textbf{r2}. Сервер управляет
настройками VPN, поэтому на маршрутизаторе \textbf{r1} следует
изменить файл \textbf{/etc/openvpn/tun0.conf} следующим образом:
\begin{Verbatim}
local 172.16.1.3
proto udp
port 1194
dev tun

ifconfig 10.200.1.1 10.200.1.2
secret /etc/openvpn/keys/somesecret.key
status /var/log/openvpn/tun0.status
log /var/log/openvpn/tun0.log
\end{Verbatim}

А на маршрутизаторе \textbf{r2} этот файл следует отредактировать
следующим образом:
\begin{Verbatim}
remote 172.16.1.3 1194 
proto udp
dev tun

ifconfig 10.200.1.2 10.200.1.1
secret /etc/openvpn/keys/somesecret.key
status /var/log/openvpn/tun0.status
log /var/log/openvpn/tun0.log
\end{Verbatim}

Выполним \textbf{ip r} на маршрутизаторе \textbf{r1}:
\begin{Verbatim}
10.200.1.2 dev tun0  proto kernel  scope link  src 10.200.1.1 
10.0.0.0/16 dev eth0  proto kernel  scope link  src 10.0.0.1 
10.102.0.0/16 via 10.200.1.2 dev tun0  proto zebra  metric 2 
172.16.0.0/16 dev eth1  proto kernel  scope link  src 172.16.1.3 
default via 172.16.1.2 dev eth1 
\end{Verbatim}

Выполним \textbf{ip r} на маршрутизаторе \textbf{r2}:
\begin{Verbatim}
10.200.1.1 dev tun0  proto kernel  scope link  src 10.200.1.2 
10.0.0.0/16 via 10.200.1.1 dev tun0  proto zebra  metric 2 
10.102.0.0/16 dev eth0  proto kernel  scope link  src 10.102.0.1 
172.16.0.0/16 dev eth1  proto kernel  scope link  src 172.16.1.4 
default via 172.16.1.2 dev eth1
\end{Verbatim}

Выполним \textbf{ip -4 a} на маршрутизаторе \textbf{r1}:
\begin{Verbatim}
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue 
    inet 127.0.0.1/8 scope host lo
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000
    inet 172.16.1.3/16 brd 172.16.255.255 scope global eth1
4: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000
    inet 10.0.0.1/16 brd 10.0.255.255 scope global eth0
5: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 100
    inet 10.200.1.1 peer 10.200.1.2/32 scope global tun0
\end{Verbatim}

Выполним \textbf{ip -4 a} на маршрутизаторе \textbf{r2}:
\begin{Verbatim}
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue 
    inet 127.0.0.1/8 scope host lo
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000
    inet 172.16.1.4/16 brd 172.16.255.255 scope global eth1
4: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000
    inet 10.102.0.1/16 brd 10.102.255.255 scope global eth0
5: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 100
    inet 10.200.1.2 peer 10.200.1.1/32 scope global tun0
\end{Verbatim}

Выполним \textbf{tcpdump -tvn -i tun0 -s 1518 udp} на маршрутизаторе
\textbf{r1}:
\begin{Verbatim}
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
\end{Verbatim}


\section{Правила фильтации пакетов и трансляции пдресов}

Сценарий фильтрации на маршрутизаторе \textbf{r1}:

\begin{Verbatim}
#!/bin/sh
LAN=eth0
INET=eth1
VPN=tun0

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables -F

# Удаление правил в таблице "nat" (её надо указать явно).
iptables -F -t nat

# По-умолчанию все маршрутизируемые пакеты выбрасываются.
iptables --policy FORWARD DROP

# Для s11 разрешаем входящие соединения по smtp (порт 25)
iptables -t nat -A PREROUTING -p tcp --dport 25 -i $INET -j DNAT --to 10.0.4.10:25

# Для s12 разрешаем входящие соелинения по http (порт 80)
iptables -t nat -A PREROUTING -p tcp --dport 80 -i $INET -j DNAT --to 10.0.4.20:80

# Разрешаем любую маршрутизацию для интерфейса VPN
iptables -A FORWARD -i $VPN -j ACCEPT
iptables -A FORWARD -o $VPN -j ACCEPT

# Для ws11
# разрешаем сеть МГТУ
iptables -A FORWARD -i $LAN -s 10.0.1.1 -d 172.168.0.0/16 -p tcp --dport 80 -j ACCEPT
# запрещаем vkontakte.ru
iptables -A FORWARD -i $LAN -s 10.0.1.1 -d 87.240.156.164/30 -p tcp --dport 80 -j DROP
# запрещаем vk.com
iptables -A FORWARD -i $LAN -s 10.0.1.1 -d 87.240.131.96/27 -p tcp --dport 80 -j DROP
# разрешаем все остальные http запросы
iptables -A FORWARD -i $LAN -s 10.0.1.1 -p tcp --dport 80 -j ACCEPT

# Для ws12
# разрешаем rambler.ru
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.70.3 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.70.3 -p tcp --dport 443 -j ACCEPT
# разрешаем mail.ru
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 217.69.139.192/28 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 94.100.180.192/28 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 217.69.139.192/28 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 94.100.180.192/28 -p tcp --dport 443 -j ACCEPT

# Для ws13
# разрешаем сеть МГТУ
iptables -A FORWARD -i $LAN -s 10.0.3.1 -d 172.168.0.0/16 -p tcp -j ACCEPT
# разрешаем порты 80, 110, 443
iptables -A FORWARD -i $LAN -s 10.0.3.1 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.3.1 -p tcp --dport 110 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.3.1 -p tcp --dport 443 -j ACCEPT

# Включение SNAT для маршрутизируемых пакетов, выходящих
# через eth1. Это правило выполняется после самой маршрутизации
# (POSTROUTING) и помещается в таблицу правил "nat".
iptables -t nat -A POSTROUTING -o $INET -j MASQUERADE
# Разрешение пакетов-ответов (они отслеживаются как 
# -- state ESTABLISHED)
iptables -A FORWARD -m state --state ESTABLISHED -i $INET -j ACCEPT
\end{Verbatim}

Выполним \textbf{iptables -L -nv} на \textbf{r1}:
\begin{Verbatim}
Chain INPUT (policy ACCEPT 2892 packets, 236K bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     all  --  tun0   *       0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     all  --  *      tun0    0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     tcp  --  eth0   *       10.0.1.1             172.168.0.0/16      tcp dpt:80 
    0     0 DROP       tcp  --  eth0   *       10.0.1.1             87.240.156.164/30   tcp dpt:80 
    0     0 DROP       tcp  --  eth0   *       10.0.1.1             87.240.131.96/27    tcp dpt:80 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.1.1             0.0.0.0/0           tcp dpt:80 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.2.1             81.19.70.3          tcp dpt:80 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.2.1             81.19.70.3          tcp dpt:443 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.2.1             217.69.139.192/28   tcp dpt:80 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.2.1             94.100.180.192/28   tcp dpt:80 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.2.1             217.69.139.192/28   tcp dpt:443 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.2.1             94.100.180.192/28   tcp dpt:443 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.3.1             172.168.0.0/16      
    0     0 ACCEPT     tcp  --  eth0   *       10.0.3.1             0.0.0.0/0           tcp dpt:80 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.3.1             0.0.0.0/0           tcp dpt:110 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.3.1             0.0.0.0/0           tcp dpt:443 
    0     0 ACCEPT     all  --  eth1   *       0.0.0.0/0            0.0.0.0/0           state ESTABLISHED 

Chain OUTPUT (policy ACCEPT 2006 packets, 162K bytes)
 pkts bytes target     prot opt in     out     source               destination  
\end{Verbatim}

Выполним \textbf{iptables -L -nv -t nat} на \textbf{r1}:
\begin{Verbatim}
Chain PREROUTING (policy ACCEPT 254 packets, 35657 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DNAT       tcp  --  eth1   *       0.0.0.0/0            0.0.0.0/0           tcp dpt:25 to:10.0.4.10:25 
    0     0 DNAT       tcp  --  eth1   *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80 to:10.0.4.20:80 

Chain POSTROUTING (policy ACCEPT 15 packets, 836 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MASQUERADE  all  --  *      eth1    0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 15 packets, 836 bytes)
 pkts bytes target     prot opt in     out     source               destination
\end{Verbatim}

Сценарий фильтрации на маршрутизаторе \textbf{r2}:

\begin{Verbatim}
#!/bin/sh
LAN=eth0
INET=eth1
VPN=tun0

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables -F

# Удаление правил в таблице "nat" (её надо указать явно).
iptables -F -t nat

# По-умолчанию все маршрутизируемые пакеты выбрасываются.
iptables --policy FORWARD DROP

# Разрешаем любую маршрутизацию для интерфейса VPN
iptables -A FORWARD -i $VPN -j ACCEPT
iptables -A FORWARD -o $VPN -j ACCEPT

# Для pc21
# разрешаем порт 80
iptables -A FORWARD -o $INET -p tcp --dport 80 -j ACCEPT

# Включение SNAT для маршрутизируемых пакетов, выходящих
# через eth1. Это правило выполняется после самой маршрутизации
# (POSTROUTING) и помещается в таблицу правил "nat".
iptables -t nat -A POSTROUTING -o $INET -j MASQUERADE
# Разрешение пакетов-ответов (они отслеживаются как
# -- state ESTABLISHED)
iptables -A FORWARD -m state --state ESTABLISHED -i $INET -j ACCEPT
\end{Verbatim}

Выполним \textbf{iptables -L -nv} на \textbf{r2}:
\begin{Verbatim}
Chain INPUT (policy ACCEPT 3027 packets, 242K bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     all  --  tun0   *       0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     all  --  *      tun0    0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     tcp  --  *      eth1    0.0.0.0/0            0.0.0.0/0           tcp dpt:80 
    0     0 ACCEPT     all  --  eth1   *       0.0.0.0/0            0.0.0.0/0           state ESTABLISHED 

Chain OUTPUT (policy ACCEPT 2126 packets, 172K bytes)
 pkts bytes target     prot opt in     out     source               destination     
\end{Verbatim}

Выполним \textbf{iptables -L -nv -t nat} на \textbf{r2}:
\begin{Verbatim}
Chain PREROUTING (policy ACCEPT 256 packets, 36517 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain POSTROUTING (policy ACCEPT 16 packets, 920 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MASQUERADE  all  --  *      eth1    0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 27 packets, 1648 bytes)
 pkts bytes target     prot opt in     out     source               destination 
\end{Verbatim}

\section{Проверка трансляции}

SNAT

\begin{Verbatim}
дамп SNAT в LAN
\end{Verbatim}

\begin{Verbatim}
дамп SNAT (снаружи)
\end{Verbatim}

DNAT

\begin{Verbatim}
дамп DNAT (снаружи)
\end{Verbatim}

\begin{Verbatim}
дамп DNAT в LAN
\end{Verbatim}


\section{Проверка правил фильтрации}

Используем telnet.

\section{Проверка доступа к внутреннему серверу}

Используем telnet.

\end{document}
