\documentclass[a4paper,12pt]{article}

\input{header.tex}

\title{Отчёт по лабораторной работе \\ <<Локальные сети>>}
\author{Фроловский Алексей Вадимлвич}

\begin{document}

\maketitle

\tableofcontents

% Текст отчёта должен быть читаемым!!! Написанное здесь является рыбой.

\section{Получение адреса по DHCP}

Получение "случайного" адреса можно продемонстрировать на примере
сети \textbf{lan2} с адресом \textbf{10.102.0.0/16}. Для этого
необходимо настроить службу DHCP на маршрутизаторе \textbf{r2}:
в файле \textbf{/etc/dhcp3/dhcpd.conf} следует указать следующие
настройки:
\begin{Verbatim}
subnet 172.16.0.0 netmask 255.255.0.0 \{\}

subnet 10.102.0.0 netmask 255.255.0.0
\{
  range 10.102.0.2 10.102.0.200;
  option routers 10.102.0.1;
  option domain-name-servers 192.168.0.1;
\}
\end{Verbatim}

Отметим, что в настройке \textbf{range} указывается диапазон,
в котором будут динамически выдаваться ip-адреса, в
\textbf{option routers} - ip-адреса маршрутизаторов сети,
\textbf{option domain-name-servers} - ip-адреса DNS-серверов.

Выполним на маршрутизаторе \textbf{r2}:
\begin{Verbatim}
tcpdump -tnv -i eth0 udp
\end{Verbatim}

Получим следующий вывод:
\begin{Verbatim}
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0x82701421, Flags [none]
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.102.0.1.67 > 10.102.0.2.68: BOOTP/DHCP, Reply, length 300, xid 0x82701421, Flags [none]
          Your-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0x82701421, Flags [none]
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.102.0.1.67 > 10.102.0.2.68: BOOTP/DHCP, Reply, length 300, xid 0x82701421, Flags [none]
          Your-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 328) 
	10.102.0.2.68 > 10.102.0.1.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0x7185b80d, Flags [none]
          Client-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0xe433c82b, Flags [none]
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.102.0.1.67 > 10.102.0.2.68: BOOTP/DHCP, Reply, length 300, xid 0xe433c82b, Flags [none]
          Your-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ee, 
		length 300, xid 0xe433c82b, Flags [none]
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.102.0.1.67 > 10.102.0.2.68: BOOTP/DHCP, Reply, length 300, xid 0xe433c82b, Flags [none]
          Your-IP 10.102.0.2
          Client-Ethernet-Address 10:10:10:10:10:ee [|bootp]
\end{Verbatim}

Получение "фиксированных" адресов можно продемонстрировать на
примере сети \textbf{lan1} с адресом \textbf{10.0.0.0/16}. Для
этого необходимо настроить службу DHCP на маршрутизаторе
\textbf{r1}: в файле \textbf{/etc/dhcp3/dhcpd.conf} следует
указать следующие настройки:
\begin{Verbatim}
subnet 172.16.0.0 netmask 255.255.0.0 \{\}

subnet 10.0.0.0 netmask 255.255.0.0
\{
  range 10.0.0.2 10.0.10.200;
  option routers 10.0.0.1;
  option domain-name-servers 192.168.0.1;
\}

host ws11 \{
    hardware ethernet 10:10:10:10:10:BA;
    fixed-address 10.0.1.1;
\}

host ws12 \{
    hardware ethernet 10:10:10:10:10:BB;
    fixed-address 10.0.2.1;
\}

host ws13 \{
    hardware ethernet 10:10:10:10:10:BC;
    fixed-address 10.0.3.1;
\}

host s11 \{
    hardware ethernet 10:10:10:10:20:AA;
    fixed-address 10.0.4.10;
\}

host s12 \{
    hardware ethernet 10:10:10:10:20:BB;
    fixed-address 10.0.4.20;
\}
\end{Verbatim}

Выполним на маршрутизаторе \textbf{r2}:
\begin{Verbatim}
tcpdump -tnv -i eth0 udp
\end{Verbatim}

Получим следующий вывод:
\begin{Verbatim}
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:bb, 
		length 300, xid 0x28576d02, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.20.68: BOOTP/DHCP, Reply, 
		length 300, xid 0x28576d02, Flags [none]
	  Your-IP 10.0.4.20
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:bb, 
		length 300, xid 0x28576d02, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.20.68: BOOTP/DHCP, Reply, length 300, xid 0x28576d02, Flags [none]
	  Your-IP 10.0.4.20
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 328) 
	10.0.4.10.68 > 10.0.0.1.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xc48d122e, Flags [none]
	  Client-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0xad5a342d, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.1.1.68: BOOTP/DHCP, Reply, length 300, xid 0xad5a342d, Flags [none]
	  Your-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0xad5a342d, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.1.1.68: BOOTP/DHCP, Reply, length 300, xid 0xad5a342d, Flags [none]
	  Your-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0xa001b35a, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.2.1.68: BOOTP/DHCP, Reply, length 300, xid 0xa001b35a, Flags [none]
	  Your-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0xa001b35a, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.2.1.68: BOOTP/DHCP, Reply, length 300, xid 0xa001b35a, Flags [none]
	  Your-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:bb, 
		length 300, xid 0x93a8a447, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.20.68: BOOTP/DHCP, Reply, length 300, xid 0x93a8a447, Flags [none]
	  Your-IP 10.0.4.20
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:bb, 
		length 300, xid 0x93a8a447, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.20.68: BOOTP/DHCP, Reply, length 300, xid 0x93a8a447, Flags [none]
	  Your-IP 10.0.4.20
	  Client-Ethernet-Address 10:10:10:10:20:bb [|bootp]
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 328) 
	10.0.1.1.68 > 10.0.0.1.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0x437a631f, Flags [none]
	  Client-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bc, 
		length 300, xid 0xecf5c126, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.3.1.68: BOOTP/DHCP, Reply, length 300, xid 0xecf5c126, Flags [none]
	  Your-IP 10.0.3.1
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bc, 
		length 300, xid 0xecf5c126, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.3.1.68: BOOTP/DHCP, Reply, length 300, xid 0xecf5c126, Flags [none]
	  Your-IP 10.0.3.1
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0x58752e33, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.1.1.68: BOOTP/DHCP, Reply, length 300, xid 0x58752e33, Flags [none]
	  Your-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:ba, 
		length 300, xid 0x58752e33, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.1.1.68: BOOTP/DHCP, Reply, length 300, xid 0x58752e33, Flags [none]
	  Your-IP 10.0.1.1
	  Client-Ethernet-Address 10:10:10:10:10:ba [|bootp]
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto UDP (17), length 328) 
	10.0.2.1.68 > 10.0.0.1.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0x193e306b, Flags [none]
	  Client-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0x8511b67e, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.2.1.68: BOOTP/DHCP, Reply, length 300, xid 0x8511b67e, Flags [none]
	  Your-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bb, 
		length 300, xid 0x8511b67e, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.2.1.68: BOOTP/DHCP, Reply, length 300, xid 0x8511b67e, Flags [none]
	  Your-IP 10.0.2.1
	  Client-Ethernet-Address 10:10:10:10:10:bb [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xd215445, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.10.68: BOOTP/DHCP, Reply, length 300, xid 0xd215445, Flags [none]
	  Your-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xd215445, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.10.68: BOOTP/DHCP, Reply, length 300, xid 0xd215445, Flags [none]
	  Your-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bc, 
		length 300, xid 0x3dad9929, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.3.1.68: BOOTP/DHCP, Reply, length 300, xid 0x3dad9929, Flags [none]
	  Your-IP 10.0.3.1
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:10:bc, 
		length 300, xid 0x3dad9929, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.3.1.68: BOOTP/DHCP, Reply, length 300, xid 0x3dad9929, Flags [none]
	  Your-IP 10.0.3.1
	  Client-Ethernet-Address 10:10:10:10:10:bc [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xd3cd0b29, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.10.68: BOOTP/DHCP, Reply, length 300, xid 0xd3cd0b29, Flags [none]
	  Your-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	0.0.0.0.68 > 255.255.255.255.67: BOOTP/DHCP, Request from 10:10:10:10:20:aa, 
		length 300, xid 0xd3cd0b29, Flags [none]
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
IP (tos 0x10, ttl 128, id 0, offset 0, flags [none], proto UDP (17), length 328) 
	10.0.0.1.67 > 10.0.4.10.68: BOOTP/DHCP, Reply, length 300, xid 0xd3cd0b29, Flags [none]
	  Your-IP 10.0.4.10
	  Client-Ethernet-Address 10:10:10:10:20:aa [|bootp]
\end{Verbatim}


\section{Использование VPN}

Для создания виртуальной частной сети используется служба OpenVPN.
В качестве сервера выступает маршрутизатор \textbf{r1}, ожидающего подключение, а в качестве клиента - \textbf{r2}. Сервер управляет
настройками VPN, поэтому на маршрутизаторе \textbf{r1} следует
изменить файл \textbf{/etc/openvpn/tun0.conf} следующим образом:
\begin{Verbatim}
local 172.16.1.3
proto udp
port 1194
dev tun

ifconfig 10.200.1.1 10.200.1.2
secret /etc/openvpn/keys/somesecret.key
status /var/log/openvpn/tun0.status
log /var/log/openvpn/tun0.log
\end{Verbatim}

А на маршрутизаторе \textbf{r2} этот файл следует отредактировать
следующим образом:
\begin{Verbatim}
remote 172.16.1.3 1194 
proto udp
dev tun

ifconfig 10.200.1.2 10.200.1.1
secret /etc/openvpn/keys/somesecret.key
status /var/log/openvpn/tun0.status
log /var/log/openvpn/tun0.log
\end{Verbatim}

Выполним \textbf{ip r} на маршрутизаторе \textbf{r1}:
\begin{Verbatim}
10.200.1.2 dev tun0  proto kernel  scope link  src 10.200.1.1 
10.0.0.0/16 dev eth0  proto kernel  scope link  src 10.0.0.1 
10.102.0.0/16 via 10.200.1.2 dev tun0  proto zebra  metric 2 
172.16.0.0/16 dev eth1  proto kernel  scope link  src 172.16.1.3 
default via 172.16.1.2 dev eth1 
\end{Verbatim}

Выполним \textbf{ip r} на маршрутизаторе \textbf{r2}:
\begin{Verbatim}
10.200.1.1 dev tun0  proto kernel  scope link  src 10.200.1.2 
10.0.0.0/16 via 10.200.1.1 dev tun0  proto zebra  metric 2 
10.102.0.0/16 dev eth0  proto kernel  scope link  src 10.102.0.1 
172.16.0.0/16 dev eth1  proto kernel  scope link  src 172.16.1.4 
default via 172.16.1.2 dev eth1
\end{Verbatim}

Выполним \textbf{ip -4 a} на маршрутизаторе \textbf{r1}:
\begin{Verbatim}
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue 
    inet 127.0.0.1/8 scope host lo
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000
    inet 172.16.1.3/16 brd 172.16.255.255 scope global eth1
4: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000
    inet 10.0.0.1/16 brd 10.0.255.255 scope global eth0
5: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 100
    inet 10.200.1.1 peer 10.200.1.2/32 scope global tun0
\end{Verbatim}

Выполним \textbf{ip -4 a} на маршрутизаторе \textbf{r2}:
\begin{Verbatim}
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 16436 qdisc noqueue 
    inet 127.0.0.1/8 scope host lo
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000
    inet 172.16.1.4/16 brd 172.16.255.255 scope global eth1
4: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 1000
    inet 10.102.0.1/16 brd 10.102.255.255 scope global eth0
5: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast qlen 100
    inet 10.200.1.2 peer 10.200.1.1/32 scope global tun0
\end{Verbatim}

Выполним \textbf{tcpdump -tvn -i tun0 -s 1518 udp} на маршрутизаторе
\textbf{r1}:
\begin{Verbatim}
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.2.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:      10.102.0.0/16, tag 0x0000, metric: 1, next-hop: self
IP (tos 0x0, ttl 1, id 0, offset 0, flags [DF], proto UDP (17), length 52) 10.200.1.1.520 > 224.0.0.9.520: 
	RIPv2, Response, length: 24, routes: 1
	  AFI: IPv4:        10.0.0.0/16, tag 0x0000, metric: 1, next-hop: self
\end{Verbatim}


\section{Правила фильтации пакетов и трансляции пдресов}

Сценарий фильтрации на маршрутизаторе \textbf{r1}:

\begin{Verbatim}
#!/bin/sh
LAN=eth0
INET=eth1
VPN=tun0

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables -F

# Удаление правил в таблице "nat" (её надо указать явно).
iptables -F -t nat

# По-умолчанию все маршрутизируемые пакеты выбрасываются.
iptables --policy FORWARD DROP

# Для s11 разрешаем входящие соединения по smtp (порт 25)
iptables -t nat -A PREROUTING -p tcp --dport 25 -i $INET -j DNAT --to 10.0.4.10:25
iptables -A FORWARD -i $LAN -s 10.0.4.10 -p tcp -j ACCEPT
iptables -A FORWARD -i $INET -d 10.0.4.10 -p tcp --dport 25 -j ACCEPT

# Для s12 разрешаем входящие соелинения по http (порт 80)
iptables -t nat -A PREROUTING -p tcp --dport 80 -i $INET -j DNAT --to 10.0.4.20:80
iptables -A FORWARD -i $LAN -s 10.0.4.20 -p tcp -j ACCEPT
iptables -A FORWARD -i $INET -d 10.0.4.20 -p tcp --dport 80 -j ACCEPT

# Разрешаем любую маршрутизацию для интерфейса VPN
iptables -A FORWARD -i $VPN -j ACCEPT
iptables -A FORWARD -o $VPN -j ACCEPT

# Для ws11
# разрешаем сеть МГТУ
iptables -A FORWARD -i $LAN -s 10.0.1.1 -d 172.168.0.0/16 -p tcp --dport 80 -j ACCEPT
# запрещаем vkontakte.ru
iptables -A FORWARD -i $LAN -s 10.0.1.1 -d 87.240.156.160/28 -p tcp --dport 80 -j DROP
# запрещаем vk.com
iptables -A FORWARD -i $LAN -s 10.0.1.1 -d 87.240.131.96/27 -p tcp --dport 80 -j DROP
iptables -A FORWARD -i $LAN -s 10.0.1.1 -d 87.240.143.244 -p tcp --dport 80 -j DROP
# разрешаем все остальные http запросы
iptables -A FORWARD -i $LAN -s 10.0.1.1 -p tcp --dport 80 -j ACCEPT

# Для ws12
# разрешаем rambler.ru
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.70.3 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.70.2 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.70.1 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.78.80/28 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.70.3 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.70.2 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.70.1 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 81.19.78.80/28 -p tcp --dport 443 -j ACCEPT
# разрешаем mail.ru
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 217.69.139.192/28 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 94.100.180.192/28 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 217.69.139.192/28 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.2.1 -d 94.100.180.192/28 -p tcp --dport 443 -j ACCEPT


# Для ws13
# разрешаем сеть МГТУ
iptables -A FORWARD -i $LAN -s 10.0.3.1 -d 172.168.0.0/16 -p tcp -j ACCEPT
# разрешаем порты 80, 110, 443
iptables -A FORWARD -i $LAN -s 10.0.3.1 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.3.1 -p tcp --dport 110 -j ACCEPT
iptables -A FORWARD -i $LAN -s 10.0.3.1 -p tcp --dport 443 -j ACCEPT

# Включение SNAT для маршрутизируемых пакетов, выходящих
# через eth1. Это правило выполняется после самой маршрутизации
# (POSTROUTING) и помещается в таблицу правил "nat".
iptables -t nat -A POSTROUTING -o $INET -j MASQUERADE
# Разрешение пакетов-ответов (они отслеживаются как 
# -- state ESTABLISHED)
iptables -A FORWARD -m state --state ESTABLISHED -i $INET -j ACCEPT
\end{Verbatim}

Выполним \textbf{iptables -L -nv} на \textbf{r1}:
\begin{Verbatim}
Chain INPUT (policy ACCEPT 2892 packets, 236K bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   25  1657 ACCEPT     tcp  --  eth0   *       10.0.4.10            0.0.0.0/0           
   21  1060 ACCEPT     tcp  --  eth1   *       0.0.0.0/0            10.0.4.10           tcp dpt:25 
   17   936 ACCEPT     tcp  --  eth0   *       10.0.4.20            0.0.0.0/0           
   24  1301 ACCEPT     tcp  --  eth1   *       0.0.0.0/0            10.0.4.20           tcp dpt:80 
   23  1512 ACCEPT     all  --  tun0   *       0.0.0.0/0            0.0.0.0/0           
   23  1092 ACCEPT     all  --  *      tun0    0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     tcp  --  eth0   *       10.0.1.1             172.168.0.0/16      tcp dpt:80 
    9   540 DROP       tcp  --  eth0   *       10.0.1.1             87.240.156.160/28   tcp dpt:80 
    0     0 DROP       tcp  --  eth0   *       10.0.1.1             87.240.131.96/27    tcp dpt:80 
   16   720 ACCEPT     tcp  --  eth0   *       10.0.1.1             0.0.0.0/0           tcp dpt:80 
   12   540 ACCEPT     tcp  --  eth0   *       10.0.2.1             81.19.70.3          tcp dpt:80 
   13   780 ACCEPT     tcp  --  eth0   *       10.0.2.1             81.19.70.3          tcp dpt:443 
   13   705 ACCEPT     tcp  --  eth0   *       10.0.2.1             217.69.139.192/28   tcp dpt:80 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.2.1             94.100.180.192/28   tcp dpt:80 
   12   648 ACCEPT     tcp  --  eth0   *       10.0.2.1             217.69.139.192/28   tcp dpt:443 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.2.1             94.100.180.192/28   tcp dpt:443 
    0     0 ACCEPT     tcp  --  eth0   *       10.0.3.1             172.168.0.0/16      
   16   720 ACCEPT     tcp  --  eth0   *       10.0.3.1             0.0.0.0/0           tcp dpt:80 
   18   973 ACCEPT     tcp  --  eth0   *       10.0.3.1             0.0.0.0/0           tcp dpt:110 
   18   984 ACCEPT     tcp  --  eth0   *       10.0.3.1             0.0.0.0/0           tcp dpt:443 
   67  3376 ACCEPT     all  --  eth1   *       0.0.0.0/0            0.0.0.0/0           state ESTABLISHED 



Chain OUTPUT (policy ACCEPT 96 packets, 7380 bytes)
 pkts bytes target     prot opt in     out     source               destination
\end{Verbatim}

Выполним \textbf{iptables -L -nv -t nat} на \textbf{r1}:
\begin{Verbatim}
Chain PREROUTING (policy ACCEPT 254 packets, 35657 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DNAT       tcp  --  eth1   *       0.0.0.0/0            0.0.0.0/0           tcp dpt:25 to:10.0.4.10:25 
    0     0 DNAT       tcp  --  eth1   *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80 to:10.0.4.20:80 

Chain POSTROUTING (policy ACCEPT 15 packets, 836 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MASQUERADE  all  --  *      eth1    0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 15 packets, 836 bytes)
 pkts bytes target     prot opt in     out     source               destination
\end{Verbatim}

Сценарий фильтрации на маршрутизаторе \textbf{r2}:

\begin{Verbatim}
#!/bin/sh
LAN=eth0
INET=eth1
VPN=tun0

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables -F

# Удаление правил в таблице "nat" (её надо указать явно).
iptables -F -t nat

# По-умолчанию все маршрутизируемые пакеты выбрасываются.
iptables --policy FORWARD DROP

# Разрешаем любую маршрутизацию для интерфейса VPN
iptables -A FORWARD -i $VPN -j ACCEPT
iptables -A FORWARD -o $VPN -j ACCEPT

# Для pc21
# разрешаем порт 80
iptables -A FORWARD -o $INET -p tcp --dport 80 -j ACCEPT

# Включение SNAT для маршрутизируемых пакетов, выходящих
# через eth1. Это правило выполняется после самой маршрутизации
# (POSTROUTING) и помещается в таблицу правил "nat".
iptables -t nat -A POSTROUTING -o $INET -j MASQUERADE
# Разрешение пакетов-ответов (они отслеживаются как
# -- state ESTABLISHED)
iptables -A FORWARD -m state --state ESTABLISHED -i $INET -j ACCEPT
\end{Verbatim}

Выполним \textbf{iptables -L -nv} на \textbf{r2}:
\begin{Verbatim}
Chain INPUT (policy ACCEPT 3027 packets, 242K bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     all  --  tun0   *       0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     all  --  *      tun0    0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     tcp  --  *      eth1    0.0.0.0/0            0.0.0.0/0           tcp dpt:80 
    0     0 ACCEPT     all  --  eth1   *       0.0.0.0/0            0.0.0.0/0           state ESTABLISHED 

Chain OUTPUT (policy ACCEPT 2126 packets, 172K bytes)
 pkts bytes target     prot opt in     out     source               destination     
\end{Verbatim}

Выполним \textbf{iptables -L -nv -t nat} на \textbf{r2}:
\begin{Verbatim}
Chain PREROUTING (policy ACCEPT 256 packets, 36517 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain POSTROUTING (policy ACCEPT 16 packets, 920 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 MASQUERADE  all  --  *      eth1    0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT 27 packets, 1648 bytes)
 pkts bytes target     prot opt in     out     source               destination 
\end{Verbatim}

\section{Проверка трансляции}

Для демонстрации SNAT преобразований выполним \textbf{telnet 213.180.193.3 80} на хосте \textbf{ws11}.

Вывод \textbf{tcpdump -i eth0 -p tcp -tnv} на хосте на \textbf{ws11}:
\begin{Verbatim}
tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 96 bytes
IP (tos 0x10, ttl 64, id 46644, offset 0, flags [DF], proto TCP (6), length 60)
 10.0.1.1.55843 > 213.180.193.3.80: S, cksum 0xf413 (correct), 2326482989:23264
82989(0) win 5840 <mss 1460,sackOK,timestamp 4294960665 0,nop,wscale 4>
IP (tos 0x0, ttl 54, id 0, offset 0, flags [DF], proto TCP (6), length 52) 213.180.193.3.80 > 10.0.1.1.55843: S, cksum 0x5250 (correct), 3348940585:3348940585(0) ack 2326482990 win 14100 <mss 1410,nop,nop,sackOK,nop,wscale 9>
IP (tos 0x10, ttl 64, id 46645, offset 0, flags [DF], proto TCP (6), length 40) 10.0.1.1.55843 > 213.180.193.3.80: ., cksum 0xc899 (correct), ack 1 win 365
IP (tos 0x10, ttl 64, id 46646, offset 0, flags [DF], proto TCP (6), length 46) 10.0.1.1.55843 > 213.180.193.3.80: P, cksum 0xd3a7 (correct), 1:7(6) ack 1 win 365
IP (tos 0x0, ttl 54, id 44409, offset 0, flags [DF], proto TCP (6), length 40) 213.180.193.3.80 > 10.0.1.1.55843: ., cksum 0xc9e4 (correct), ack 7 win 28
IP (tos 0x0, ttl 54, id 44410, offset 0, flags [DF], proto TCP (6), length 206) 213.180.193.3.80 > 10.0.1.1.55843: P 1:167(166) ack 7 win 28
IP (tos 0x10, ttl 64, id 46647, offset 0, flags [DF], proto TCP (6), length 40) 10.0.1.1.55843 > 213.180.193.3.80: ., cksum 0xc7aa (correct), ack 167 win 432
IP (tos 0x0, ttl 54, id 44411, offset 0, flags [DF], proto TCP (6), length 40) 213.180.193.3.80 > 10.0.1.1.55843: F, cksum 0xc93d (correct), 167:167(0) ack 7 win 28
IP (tos 0x10, ttl 64, id 46648, offset 0, flags [DF], proto TCP (6), length 40) 10.0.1.1.55843 > 213.180.193.3.80: F, cksum 0xc7a8 (correct), 7:7(0) ack 168 win 432
IP (tos 0x0, ttl 54, id 44412, offset 0, flags [DF], proto TCP (6), length 40) 213.180.193.3.80 > 10.0.1.1.55843: ., cksum 0xc93c (correct), ack 8 win 28
\end{Verbatim}

Вывод \textbf{tcpdump -i eth1 -p tcp -tnv}  на маршрутизаторе \textbf{r1}:
\begin{Verbatim}
IP (tos 0x10, ttl 63, id 46644, offset 0, flags [DF], proto TCP (6), length 60) 172.16.1.3.55843 > 213.180.193.3.80: S, cksum 0x5201 (correct), 2326482989:2326482989(0) win 5840 <mss 1460,sackOK,timestamp 4294960665 0,nop,wscale 4>
IP (tos 0x0, ttl 55, id 0, offset 0, flags [DF], proto TCP (6), length 52) 213.180.193.3.80 > 172.16.1.3.55843: S, cksum 0xb03d (correct), 3348940585:3348940585(0) ack 2326482990 win 14100 <mss 1410,nop,nop,sackOK,nop,wscale 9>
IP (tos 0x10, ttl 63, id 46645, offset 0, flags [DF], proto TCP (6), length 40) 172.16.1.3.55843 > 213.180.193.3.80: ., cksum 0x2687 (correct), ack 1 win 365
IP (tos 0x10, ttl 63, id 46646, offset 0, flags [DF], proto TCP (6), length 46) 172.16.1.3.55843 > 213.180.193.3.80: P, cksum 0x3195 (correct), 1:7(6) ack 1 win 365
IP (tos 0x0, ttl 55, id 44409, offset 0, flags [DF], proto TCP (6), length 40) 213.180.193.3.80 > 172.16.1.3.55843: ., cksum 0x27d2 (correct), ack 7 win 28
IP (tos 0x0, ttl 55, id 44410, offset 0, flags [DF], proto TCP (6), length 206) 213.180.193.3.80 > 172.16.1.3.55843: P 1:167(166) ack 7 win 28
IP (tos 0x0, ttl 55, id 44411, offset 0, flags [DF], proto TCP (6), length 40) 213.180.193.3.80 > 172.16.1.3.55843: F, cksum 0x272b (correct), 167:167(0) ack 7 win 28
IP (tos 0x10, ttl 63, id 46647, offset 0, flags [DF], proto TCP (6), length 40) 172.16.1.3.55843 > 213.180.193.3.80: ., cksum 0x2598 (correct), ack 167 win 432
IP (tos 0x10, ttl 63, id 46648, offset 0, flags [DF], proto TCP (6), length 40) 172.16.1.3.55843 > 213.180.193.3.80: F, cksum 0x2596 (correct), 7:7(0) ack 168 win 432
IP (tos 0x0, ttl 55, id 44412, offset 0, flags [DF], proto TCP (6), length 40) 213.180.193.3.80 > 172.16.1.3.55843: ., cksum 0x272a (correct), ack 8 win 28
\end{Verbatim}

Для демонстрации DNAT преобразований выполним \textbf{telnet 172.16.1.3 80}.

Вывод \textbf{tcpdump -i eth1 -p tcp -tnv}  на маршрутизаторе \textbf{r1}:
\begin{Verbatim}
IP (tos 0x10, ttl 64, id 3896, offset 0, flags [DF], proto TCP (6), length 60) 172.16.1.2.58126 > 172.16.1.3.80: S, cksum 0x5323 (correct), 3448690626:3448690626(0) win 14600 <mss 1460,sackOK,timestamp 514298 0,nop,wscale 4>
IP (tos 0x0, ttl 63, id 0, offset 0, flags [DF], proto TCP (6), length 60) 172.16.1.3.80 > 172.16.1.2.58126: S, cksum 0x6a0a (correct), 3793067127:3793067127(0) ack 3448690627 win 5792 <mss 1460,sackOK,timestamp 167136 514298,nop,wscale 4>
IP (tos 0x10, ttl 64, id 3897, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.2.58126 > 172.16.1.3.80: ., cksum 0xabdc (correct), ack 1 win 913 <nop,nop,timestamp 514304 167136>
IP (tos 0x0, ttl 63, id 0, offset 0, flags [DF], proto TCP (6), length 60) 172.16.1.3.80 > 172.16.1.2.58126: S, cksum 0x6888 (correct), 3793067127:3793067127(0) ack 3448690627 win 5792 <mss 1460,sackOK,timestamp 167516 514304,nop,wscale 4>
IP (tos 0x10, ttl 64, id 3898, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.2.58126 > 172.16.1.3.80: ., cksum 0xa829 (correct), ack 1 win 913 <nop,nop,timestamp 515251 167136>
IP (tos 0x10, ttl 64, id 3899, offset 0, flags [DF], proto TCP (6), length 58) 172.16.1.2.58126 > 172.16.1.3.80: P, cksum 0xb01b (correct), 1:7(6) ack 1 win 913 <nop,nop,timestamp 516047 167136>
IP (tos 0x0, ttl 63, id 5090, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.3.80 > 172.16.1.2.58126: ., cksum 0xa474 (correct), ack 7 win 362 <nop,nop,timestamp 167834 516047>
IP (tos 0x0, ttl 63, id 5091, offset 0, flags [DF], proto TCP (6), length 342) 172.16.1.3.80 > 172.16.1.2.58126: P 1:291(290) ack 7 win 362 <nop,nop,timestamp 167834 516047>
IP (tos 0x10, ttl 64, id 3900, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.2.58126 > 172.16.1.3.80: ., cksum 0xa0e4 (correct), ack 291 win 980 <nop,nop,timestamp 516051 167834>
IP (tos 0x0, ttl 63, id 5092, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.3.80 > 172.16.1.2.58126: F, cksum 0xa34d (correct), 291:291(0) ack 7 win 362 <nop,nop,timestamp 167834 516051>
IP (tos 0x10, ttl 64, id 3901, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.2.58126 > 172.16.1.3.80: F, cksum 0xa0e2 (correct), 7:7(0) ack 292 win 980 <nop,nop,timestamp 516051 167834>
IP (tos 0x0, ttl 63, id 5093, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.3.80 > 172.16.1.2.58126: ., cksum 0xa34c (correct), ack 8 win 362 <nop,nop,timestamp 167834 516051>
\end{Verbatim}

Вывод \textbf{tcpdump -i eth0 -p tcp -tnv} на хосте \textbf{s11}:
\begin{Verbatim}
IP (tos 0x10, ttl 63, id 3896, offset 0, flags [DF], proto TCP (6), length 60) 172.16.1.2.58126 > 10.0.4.20.80: S, cksum 0xf222 (correct), 3448690626:3448690626(0) win 14600 <mss 1460,sackOK,timestamp 514298 0,nop,wscale 4>
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 60) 10.0.4.20.80 > 172.16.1.2.58126: S, cksum 0x090a (correct), 3793067127:3793067127(0) ack 3448690627 win 5792 <mss 1460,sackOK,timestamp 167136 514298,nop,wscale 4>
IP (tos 0x10, ttl 63, id 3897, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.2.58126 > 10.0.4.20.80: ., cksum 0x4adc (correct), ack 1 win 913 <nop,nop,timestamp 514304 167136>
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 60) 10.0.4.20.80 > 172.16.1.2.58126: S, cksum 0x0788 (correct), 3793067127:3793067127(0) ack 3448690627 win 5792 <mss 1460,sackOK,timestamp 167516 514304,nop,wscale 4>
IP (tos 0x10, ttl 63, id 3898, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.2.58126 > 10.0.4.20.80: ., cksum 0x4729 (correct), ack 1 win 913 <nop,nop,timestamp 515251 167136>
IP (tos 0x10, ttl 63, id 3899, offset 0, flags [DF], proto TCP (6), length 58) 172.16.1.2.58126 > 10.0.4.20.80: P, cksum 0x4f1b (correct), 1:7(6) ack 1 win 913 <nop,nop,timestamp 516047 167136>
IP (tos 0x0, ttl 64, id 5090, offset 0, flags [DF], proto TCP (6), length 52) 10.0.4.20.80 > 172.16.1.2.58126: ., cksum 0x4374 (correct), ack 7 win 362 <nop,nop,timestamp 167834 516047>
IP (tos 0x0, ttl 64, id 5091, offset 0, flags [DF], proto TCP (6), length 342) 10.0.4.20.80 > 172.16.1.2.58126: P 1:291(290) ack 7 win 362 <nop,nop,timestamp 167834 516047>
IP (tos 0x10, ttl 63, id 3900, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.2.58126 > 10.0.4.20.80: ., cksum 0x3fe4 (correct), ack 291 win 980 <nop,nop,timestamp 516051 167834>
IP (tos 0x0, ttl 64, id 5092, offset 0, flags [DF], proto TCP (6), length 52) 10.0.4.20.80 > 172.16.1.2.58126: F, cksum 0x424d (correct), 291:291(0) ack 7 win 362 <nop,nop,timestamp 167834 516051>
IP (tos 0x10, ttl 63, id 3901, offset 0, flags [DF], proto TCP (6), length 52) 172.16.1.2.58126 > 10.0.4.20.80: F, cksum 0x3fe2 (correct), 7:7(0) ack 292 win 980 <nop,nop,timestamp 516051 167834>
IP (tos 0x0, ttl 64, id 5093, offset 0, flags [DF], proto TCP (6), length 52) 10.0.4.20.80 > 172.16.1.2.58126: ., cksum 0x424c (correct), ack 8 win 362 <nop,nop,timestamp 167834 516051>
\end{Verbatim}


\section{Проверка правил фильтрации}

Проверим правильность найтройки правил фильтрации на маршрутизаторах
с использованием  telnet и traceroute.

С хоста \textbf{ws11} должны быть доступны любые соединения по vpn и соединения на
порте 80, кроме сервисов vkontakte.ru и vk.com.
Выполним с хоста \textbf{ws11} \textbf{telnet 87.240.156.161 80} для проверки запрещения подключения
к сервису vkontakte.ru на порту 80:
\begin{Verbatim}
ws11:~# telnet 87.240.156.161 80
Trying 87.240.156.161...
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:10:24.196385 IP 10.0.1.1.48642 > srv161-131.vkontakte.ru.www: S 2476894689:2476894689(0) win 5840 <mss 1460,sackOK,timestamp 538377 0,nop,wscale 4>
\end{Verbatim}

Выполним с хоста \textbf{ws11} \textbf{telnet 213.180.193.3 80},  чтобы проверить, что
происходит подключение к другим сервисам, например, ya.ru:
\begin{Verbatim}
ws11:~# telnet 213.180.193.3 80
Trying 213.180.193.3...
Connected to 213.180.193.3.
Escape character is '^]'.
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:11:25.989192 IP 10.0.1.1.52554 > www.yandex.ru.www: S 3468065123:3468065123(0) win 5840 <mss 1460,sackOK,timestamp 544553 0,nop,wscale 4>
09:11:25.989239 IP 172.16.1.3.52554 > www.yandex.ru.www: S 3468065123:3468065123(0) win 5840 <mss 1460,sackOK,timestamp 544553 0,nop,wscale 4>
09:11:25.994747 IP www.yandex.ru.www > 172.16.1.3.52554: S 3290289542:3290289542(0) ack 3468065124 win 14100 <mss 1410,nop,nop,sackOK,nop,wscale 9>
09:11:25.994759 IP www.yandex.ru.www > 10.0.1.1.52554: S 3290289542:3290289542(0) ack 3468065124 win 14100 <mss 1410,nop,nop,sackOK,nop,wscale 9>
09:11:25.994900 IP 10.0.1.1.52554 > www.yandex.ru.www: . ack 1 win 365
09:11:25.994909 IP 172.16.1.3.52554 > www.yandex.ru.www: . ack 1 win 365
09:11:28.241949 IP 10.0.1.1.52554 > www.yandex.ru.www: F 1:1(0) ack 1 win 365
09:11:28.242035 IP 172.16.1.3.52554 > www.yandex.ru.www: F 1:1(0) ack 1 win 365
09:11:28.246888 IP www.yandex.ru.www > 172.16.1.3.52554: F 1:1(0) ack 2 win 28
09:11:28.246946 IP www.yandex.ru.www > 10.0.1.1.52554: F 1:1(0) ack 2 win 28
09:11:28.247900 IP 10.0.1.1.52554 > www.yandex.ru.www: . ack 2 win 365
09:11:28.247940 IP 172.16.1.3.52554 > www.yandex.ru.www: . ack 2 win 365
\end{Verbatim}

Выполним с хоста \textbf{ws11} \textbf{telnet 217.69.139.90 143},  чтобы проверить,
что не происходит подключение к сервисам, например, imap.mail.ru на порту 143:
\begin{Verbatim}
ws11:~# telnet 217.69.139.90 143
Trying 217.69.139.90...
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:12:00.269976 IP 10.0.1.1.46751 > imap.mail.ru.imap2: S 4002257164:4002257164(0) win 5840 <mss 1460,sackOK,timestamp 547983 0,nop,wscale 4>
\end{Verbatim}

Выполним с хоста \textbf{ws11} \textbf{traceroute -n 10.102.0.2},  чтобы проверить,
что разрешен vpn:
\begin{Verbatim}
ws11:~# traceroute -n 10.102.0.2
traceroute to 10.102.0.2 (10.102.0.2), 64 hops max, 40 byte packets
 1 ^[[6~ 10.0.0.1  1 ms  0 ms  0 ms
 2  10.200.1.2  1 ms  1 ms  1 ms
 3  10.102.0.2  1 ms  1 ms  1 ms
\end{Verbatim}


С хоста \textbf{ws12} должны быть доступны любые соединения по vpn и
соедиения на порте 80, 443 только для mail.ru и rambler.ru. 

Выполним с хоста \textbf{ws12} \textbf{telnet 217.69.139.199 80} для проверки
разрешения подключения к mail.ru на порту 80:
\begin{Verbatim}
ws12:~# telnet 217.69.139.199 80
Trying 217.69.139.199...
Connected to 217.69.139.199.
Escape character is '^]'.
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:12:27.280578 IP 10.0.2.1.60823 > ms.mail.ru.8: S 121273156:121273156(0) win 5840 <mss 1460,sackOK,timestamp 550640 0,nop,wscale 4>
09:12:30.233939 IP 10.0.2.1.60823 > ms.mail.ru.8: S 121273156:121273156(0) win 5840 <mss 1460,sackOK,timestamp 550940 0,nop,wscale 4>
09:12:32.223129 IP 10.0.2.1.45731 > ms.mail.ru.www: S 197637687:197637687(0) win 5840 <mss 1460,sackOK,timestamp 551133 0,nop,wscale 4>
09:12:32.223215 IP 172.16.1.3.45731 > ms.mail.ru.www: S 197637687:197637687(0) win 5840 <mss 1460,sackOK,timestamp 551133 0,nop,wscale 4>
09:12:32.226715 IP ms.mail.ru.www > 172.16.1.3.45731: S 1920446077:1920446077(0) ack 197637688 win 5592 <mss 1410,sackOK,timestamp 1353492037 551133>
09:12:32.226762 IP ms.mail.ru.www > 10.0.2.1.45731: S 1920446077:1920446077(0) ack 197637688 win 5592 <mss 1410,sackOK,timestamp 1353492037 551133>
09:12:32.227450 IP 10.0.2.1.45731 > ms.mail.ru.www: . ack 1 win 5840 <nop,nop,timestamp 551133 1353492037>
09:12:32.227470 IP 172.16.1.3.45731 > ms.mail.ru.www: . ack 1 win 5840 <nop,nop,timestamp 551133 1353492037>
09:12:34.022451 IP 10.0.2.1.45731 > ms.mail.ru.www: F 1:1(0) ack 1 win 5840 <nop,nop,timestamp 551318 1353492037>
09:12:34.022537 IP 172.16.1.3.45731 > ms.mail.ru.www: F 1:1(0) ack 1 win 5840 <nop,nop,timestamp 551318 1353492037>
09:12:34.037861 IP ms.mail.ru.www > 172.16.1.3.45731: F 1:1(0) ack 2 win 5592 <nop,nop,timestamp 1353493837 551318>
09:12:34.037939 IP ms.mail.ru.www > 10.0.2.1.45731: F 1:1(0) ack 2 win 5592 <nop,nop,timestamp 1353493837 551318>
09:12:34.038900 IP 10.0.2.1.45731 > ms.mail.ru.www: . ack 2 win 5840 <nop,nop,timestamp 551318 1353493837>
09:12:34.038956 IP 172.16.1.3.45731 > ms.mail.ru.www: . ack 2 win 5840 <nop,nop,timestamp 551318 1353493837>
\end{Verbatim}

Выполним с хоста \textbf{ws12} \textbf{telnet 217.69.139.199 443} для проверки
разрешения подключения к mail.ru на порту 443:
\begin{Verbatim}
ws12:~# telnet 217.69.139.199 443
Trying 217.69.139.199...
Connected to 217.69.139.199.
Escape character is '^]'.
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:13:07.499510 IP 10.0.2.1.48723 > ms.mail.ru.https: S 737448714:737448714(0) win 5840 <mss 1460,sackOK,timestamp 554663 0,nop,wscale 4>
09:13:07.499554 IP 172.16.1.3.48723 > ms.mail.ru.https: S 737448714:737448714(0) win 5840 <mss 1460,sackOK,timestamp 554663 0,nop,wscale 4>
09:13:07.695705 IP ms.mail.ru.https > 172.16.1.3.48723: S 726899448:726899448(0) ack 737448715 win 5592 <mss 1410,sackOK,timestamp 646163147 554663>
09:13:07.695776 IP ms.mail.ru.https > 10.0.2.1.48723: S 726899448:726899448(0) ack 737448715 win 5592 <mss 1410,sackOK,timestamp 646163147 554663>
09:13:07.698913 IP 10.0.2.1.48723 > ms.mail.ru.https: . ack 1 win 5840 <nop,nop,timestamp 554685 646163147>
09:13:07.698958 IP 172.16.1.3.48723 > ms.mail.ru.https: . ack 1 win 5840 <nop,nop,timestamp 554685 646163147>
09:13:09.216364 IP 10.0.2.1.48723 > ms.mail.ru.https: F 1:1(0) ack 1 win 5840 <nop,nop,timestamp 554838 646163147>
09:13:09.216427 IP 172.16.1.3.48723 > ms.mail.ru.https: F 1:1(0) ack 1 win 5840 <nop,nop,timestamp 554838 646163147>
09:13:09.264515 IP ms.mail.ru.https > 172.16.1.3.48723: F 1:1(0) ack 2 win 5592 <nop,nop,timestamp 646164866 554838>
09:13:09.264551 IP ms.mail.ru.https > 10.0.2.1.48723: F 1:1(0) ack 2 win 5592 <nop,nop,timestamp 646164866 554838>
09:13:09.264910 IP 10.0.2.1.48723 > ms.mail.ru.https: . ack 2 win 5840 <nop,nop,timestamp 554843 646164866>
09:13:09.264922 IP 172.16.1.3.48723 > ms.mail.ru.https: . ack 2 win 5840 <nop,nop,timestamp 554843 646164866>
\end{Verbatim}

Выполним с хоста \textbf{ws12} \textbf{telnet 81.19.70.3 80} для проверки
разрешения подключения к rambler.ru на порту 80:
\begin{Verbatim}
ws12:~# telnet 81.19.70.3 80
Trying 81.19.70.3...
Connected to 81.19.70.3.
Escape character is '^]'.
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:13:38.367196 IP 10.0.2.1.44626 > rambler.ru.www: S 1224014536:1224014536(0) win 5840 <mss 1460,sackOK,timestamp 557752 0,nop,wscale 4>
09:13:38.367283 IP 172.16.1.3.44626 > rambler.ru.www: S 1224014536:1224014536(0) win 5840 <mss 1460,sackOK,timestamp 557752 0,nop,wscale 4>
09:13:38.382347 IP rambler.ru.www > 172.16.1.3.44626: S 2113783475:2113783475(0) ack 1224014537 win 8192 <mss 1460,sackOK,eol>
09:13:38.382415 IP rambler.ru.www > 10.0.2.1.44626: S 2113783475:2113783475(0) ack 1224014537 win 8192 <mss 1460,sackOK,eol>
09:13:38.383579 IP 10.0.2.1.44626 > rambler.ru.www: . ack 1 win 5840
09:13:38.383592 IP 172.16.1.3.44626 > rambler.ru.www: . ack 1 win 5840
09:13:40.220247 IP 10.0.2.1.44626 > rambler.ru.www: F 1:1(0) ack 1 win 5840
09:13:40.220332 IP 172.16.1.3.44626 > rambler.ru.www: F 1:1(0) ack 1 win 5840
09:13:40.223675 IP rambler.ru.www > 172.16.1.3.44626: . ack 2 win 8760
09:13:40.223718 IP rambler.ru.www > 10.0.2.1.44626: . ack 2 win 8760
09:13:40.223869 IP rambler.ru.www > 172.16.1.3.44626: F 1:1(0) ack 2 win 8760
09:13:40.223897 IP rambler.ru.www > 10.0.2.1.44626: F 1:1(0) ack 2 win 8760
09:13:40.225093 IP 10.0.2.1.44626 > rambler.ru.www: . ack 2 win 5840
09:13:40.225152 IP 172.16.1.3.44626 > rambler.ru.www: . ack 2 win 5840
\end{Verbatim}

Выполним с хоста \textbf{ws12} \textbf{telnet 81.19.70.3 443} для проверки разрешения
подключения к rambler.ru на порту 443:
\begin{Verbatim}
ws12:~# telnet 81.19.70.3 443
Trying 81.19.70.3...
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:13:58.882319 IP 10.0.2.1.41454 > rambler.ru.https: S 1545752968:1545752968(0) win 5840 <mss 1460,sackOK,timestamp 559799 0,nop,wscale 4>
09:13:58.882401 IP 172.16.1.3.41454 > rambler.ru.https: S 1545752968:1545752968(0) win 5840 <mss 1460,sackOK,timestamp 559799 0,nop,wscale 4>
09:14:01.833875 IP 10.0.2.1.41454 > rambler.ru.https: S 1545752968:1545752968(0) win 5840 <mss 1460,sackOK,timestamp 560100 0,nop,wscale 4>
09:14:01.833997 IP 172.16.1.3.41454 > rambler.ru.https: S 1545752968:1545752968(0) win 5840 <mss 1460,sackOK,timestamp 560100 0,nop,wscale 4>
\end{Verbatim}

Выполним с хоста \textbf{ws12} \textbf{telnet 213.180.193.3 80},  чтобы проверить, что
не происходит подключение к другим сервисам, например, ya.ru:
\begin{Verbatim}
ws12:~# telnet 213.180.193.3 80
Trying 213.180.193.3...
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:15:24.153256 IP 10.0.2.1.57873 > www.yandex.ru.www: S 2883061737:2883061737(0) win 5840 <mss 1460,sackOK,timestamp 568326 0,nop,wscale 4>
\end{Verbatim}

Выполним с хоста \textbf{ws12} \textbf{telnet 217.69.139.90 143},  чтобы проверить,
что не происходит подключение к сервисам, например, imap.mail.ru на порту 143:
\begin{Verbatim}
ws12:~# telnet 217.69.139.90 143
Trying 217.69.139.90...
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:15:51.317248 IP 10.0.2.1.52452 > imap.mail.ru.imap2: S 3321071297:3321071297(0) win 5840 <mss 1460,sackOK,timestamp 571045 0,nop,wscale 4>
\end{Verbatim}

Выполним с хоста \textbf{ws12} \textbf{traceroute -n 10.102.0.2},  чтобы проверить,
что разрешен vpn:
\begin{Verbatim}
ws12:~# traceroute -n 10.102.0.2
traceroute to 10.102.0.2 (10.102.0.2), 64 hops max, 40 byte packets
 1  10.0.0.1  8 ms  0 ms  0 ms
 2  10.200.1.2  1 ms  2 ms  4 ms
 3  10.102.0.2  2 ms  1 ms  1 ms
\end{Verbatim}


С хоста \textbf{ws13} должны быть доступны любые соединения по vpn и соедиения
на порте 80, 110, 443.

Выполним с хоста \textbf{ws13} \textbf{telnet 213.180.193.3 80},  чтобы проверить, что
происходит подключение к сервисам, например, ya.ru на порту 80:
\begin{Verbatim}
ws13:~# telnet 213.180.193.3 80
Trying 213.180.193.3...
Connected to 213.180.193.3.
Escape character is '^]'.
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:16:15.898755 IP 10.0.3.1.41706 > www.yandex.ru.www: S 3708543312:3708543312(0) win 5840 <mss 1460,sackOK,timestamp 573625 0,nop,wscale 4>
09:16:15.898868 IP 172.16.1.3.41706 > www.yandex.ru.www: S 3708543312:3708543312(0) win 5840 <mss 1460,sackOK,timestamp 573625 0,nop,wscale 4>
09:16:15.999150 IP www.yandex.ru.www > 172.16.1.3.41706: S 1592361218:1592361218(0) ack 3708543313 win 14100 <mss 1410,nop,nop,sackOK,nop,wscale 9>
09:16:15.999286 IP www.yandex.ru.www > 10.0.3.1.41706: S 1592361218:1592361218(0) ack 3708543313 win 14100 <mss 1410,nop,nop,sackOK,nop,wscale 9>
09:16:15.999921 IP 10.0.3.1.41706 > www.yandex.ru.www: . ack 1 win 365
09:16:15.999957 IP 172.16.1.3.41706 > www.yandex.ru.www: . ack 1 win 365
09:16:17.763756 IP 10.0.3.1.41706 > www.yandex.ru.www: F 1:1(0) ack 1 win 365
09:16:17.763795 IP 172.16.1.3.41706 > www.yandex.ru.www: F 1:1(0) ack 1 win 365
09:16:17.774958 IP www.yandex.ru.www > 172.16.1.3.41706: F 1:1(0) ack 2 win 28
09:16:17.774997 IP www.yandex.ru.www > 10.0.3.1.41706: F 1:1(0) ack 2 win 28
09:16:17.775421 IP 10.0.3.1.41706 > www.yandex.ru.www: . ack 2 win 365
09:16:17.775440 IP 172.16.1.3.41706 > www.yandex.ru.www: . ack 2 win 365
\end{Verbatim}

Выполним с него \textbf{telnet 213.180.204.11 443},  чтобы проверить, что
происходит подключение к сервисам, например, yandex.ru на порту 443:
\begin{Verbatim}
ws13:~# telnet 213.180.204.11 443
Trying 213.180.204.11...
Connected to 213.180.204.11.
Escape character is '^]'.
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:16:42.804688 IP 10.0.3.1.55448 > yandex.ru.https: S 4134572202:4134572202(0) win 5840 <mss 1460,sackOK,timestamp 576322 0,nop,wscale 4>
09:16:42.804727 IP 172.16.1.3.55448 > yandex.ru.https: S 4134572202:4134572202(0) win 5840 <mss 1460,sackOK,timestamp 576322 0,nop,wscale 4>
09:16:42.809123 IP yandex.ru.https > 172.16.1.3.55448: S 2931238023:2931238023(0) ack 4134572203 win 17796 <mss 8910,sackOK,timestamp 540752115 576322,nop,wscale 8>
09:16:42.809168 IP yandex.ru.https > 10.0.3.1.55448: S 2931238023:2931238023(0) ack 4134572203 win 17796 <mss 8910,sackOK,timestamp 540752115 576322,nop,wscale 8>
09:16:42.810359 IP 10.0.3.1.55448 > yandex.ru.https: . ack 1 win 365 <nop,nop,timestamp 576322 540752115>
09:16:42.810372 IP 172.16.1.3.55448 > yandex.ru.https: . ack 1 win 365 <nop,nop,timestamp 576322 540752115>
09:16:44.432097 IP 10.0.3.1.55448 > yandex.ru.https: F 1:1(0) ack 1 win 365 <nop,nop,timestamp 576489 540752115>
09:16:44.432180 IP 172.16.1.3.55448 > yandex.ru.https: F 1:1(0) ack 1 win 365 <nop,nop,timestamp 576489 540752115>
09:16:44.438621 IP yandex.ru.https > 172.16.1.3.55448: F 1:1(0) ack 2 win 70 <nop,nop,timestamp 540752522 576489>
09:16:44.438666 IP yandex.ru.https > 10.0.3.1.55448: F 1:1(0) ack 2 win 70 <nop,nop,timestamp 540752522 576489>
09:16:44.439846 IP 10.0.3.1.55448 > yandex.ru.https: . ack 2 win 365 <nop,nop,timestamp 576489 540752522>
09:16:44.439929 IP 172.16.1.3.55448 > yandex.ru.https: . ack 2 win 365 <nop,nop,timestamp 576489 540752522>
\end{Verbatim}

Выполним с него \textbf{telnet 217.69.139.74 110},  чтобы проверить, что
происходит подключение к сервисам, например, pop.mail.ru на порту 110:
\begin{Verbatim}
ws13:~# telnet 217.69.139.74 110
Trying 217.69.139.74...
Connected to 217.69.139.74.
Escape character is '^]'.
+OK
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:17:14.878888 IP 10.0.3.1.38528 > pop.mail.ru.pop3: S 335692903:335692903(0) win 5840 <mss 1460,sackOK,timestamp 579527 0,nop,wscale 4>
09:17:14.879026 IP 172.16.1.3.38528 > pop.mail.ru.pop3: S 335692903:335692903(0) win 5840 <mss 1460,sackOK,timestamp 579527 0,nop,wscale 4>
09:17:14.894750 IP pop.mail.ru.pop3 > 172.16.1.3.38528: S 1380932602:1380932602(0) ack 335692904 win 5592 <mss 1410,sackOK,timestamp 2571460250 579527>
09:17:14.894846 IP pop.mail.ru.pop3 > 10.0.3.1.38528: S 1380932602:1380932602(0) ack 335692904 win 5592 <mss 1410,sackOK,timestamp 2571460250 579527>
09:17:14.896738 IP 10.0.3.1.38528 > pop.mail.ru.pop3: . ack 1 win 5840 <nop,nop,timestamp 579534 2571460250>
09:17:14.896778 IP 172.16.1.3.38528 > pop.mail.ru.pop3: . ack 1 win 5840 <nop,nop,timestamp 579534 2571460250>
09:17:14.908283 IP pop.mail.ru.pop3 > 172.16.1.3.38528: P 1:6(5) ack 1 win 5592 <nop,nop,timestamp 2571460267 579534>
09:17:14.908324 IP pop.mail.ru.pop3 > 10.0.3.1.38528: P 1:6(5) ack 1 win 5592 <nop,nop,timestamp 2571460267 579534>
09:17:14.909156 IP 10.0.3.1.38528 > pop.mail.ru.pop3: . ack 6 win 5840 <nop,nop,timestamp 579536 2571460267>
09:17:14.909191 IP 172.16.1.3.38528 > pop.mail.ru.pop3: . ack 6 win 5840 <nop,nop,timestamp 579536 2571460267>
09:17:16.772425 IP 10.0.3.1.38528 > pop.mail.ru.pop3: F 1:1(0) ack 6 win 5840 <nop,nop,timestamp 579723 2571460267>
09:17:16.772508 IP 172.16.1.3.38528 > pop.mail.ru.pop3: F 1:1(0) ack 6 win 5840 <nop,nop,timestamp 579723 2571460267>
09:17:16.776206 IP pop.mail.ru.pop3 > 172.16.1.3.38528: F 6:6(0) ack 2 win 5592 <nop,nop,timestamp 2571462137 579723>
09:17:16.776251 IP pop.mail.ru.pop3 > 10.0.3.1.38528: F 6:6(0) ack 2 win 5592 <nop,nop,timestamp 2571462137 579723>
09:17:16.777478 IP 10.0.3.1.38528 > pop.mail.ru.pop3: . ack 7 win 5840 <nop,nop,timestamp 579723 2571462137>
09:17:16.777520 IP 172.16.1.3.38528 > pop.mail.ru.pop3: . ack 7 win 5840 <nop,nop,timestamp 579723 2571462137>
\end{Verbatim}

Выполним с него \textbf{telnet 217.69.139.90 143},  чтобы проверить, что не
происходит подключение к сервисам, например, imap.mail.ru на порту 143:
\begin{Verbatim}
ws13:~# telnet 217.69.139.90 143
Trying 217.69.139.90...
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:17:47.224581 IP 10.0.3.1.45924 > imap.mail.ru.imap2: S 843422473:843422473(0) win 5840 <mss 1460,sackOK,timestamp 582765 0,nop,wscale 4>
\end{Verbatim}

Выполним с хоста \textbf{ws13} \textbf{traceroute -n 10.102.0.2},  чтобы проверить,
что разрешен vpn:
\begin{Verbatim}
ws13:~# traceroute -n 10.102.0.2
traceroute to 10.102.0.2 (10.102.0.2), 64 hops max, 40 byte packets
 1  10.0.0.1  1 ms  0 ms  0 ms
 2  10.200.1.2  2 ms  1 ms  1 ms
 3  10.102.0.2  1 ms  1 ms  1 ms
\end{Verbatim}

С хоста \textbf{pc21} должны быть доступны любые соединения по vpn и
соединения на порте 80.

Выполним с него \textbf{telnet 213.180.193.3 80},  чтобы проверить, что
происходит подключение к сервисам, например, ya.ru на порту 80:
\begin{Verbatim}
pc21:~# telnet 213.180.193.3 80
Trying 213.180.193.3...
Connected to 213.180.193.3.
Escape character is '^]'.
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:18:20.562196 IP 10.102.0.2.59520 > www.yandex.ru.www: S 1375443222:1375443222(0) win 5840 <mss 1460,sackOK,timestamp 586071 0,nop,wscale 4>
09:18:20.586221 IP 172.16.1.4.59520 > www.yandex.ru.www: S 1375443222:1375443222(0) win 5840 <mss 1460,sackOK,timestamp 586071 0,nop,wscale 4>
09:18:20.594108 IP www.yandex.ru.www > 172.16.1.4.59520: S 92206861:92206861(0) ack 1375443223 win 14100 <mss 1410,nop,nop,sackOK,nop,wscale 9>
09:18:20.594199 IP www.yandex.ru.www > 10.102.0.2.59520: S 92206861:92206861(0) ack 1375443223 win 14100 <mss 1410,nop,nop,sackOK,nop,wscale 9>
09:18:20.594515 IP 10.102.0.2.59520 > www.yandex.ru.www: . ack 1 win 365
09:18:20.594535 IP 172.16.1.4.59520 > www.yandex.ru.www: . ack 1 win 365
09:18:22.598208 IP 10.102.0.2.59520 > www.yandex.ru.www: F 1:1(0) ack 1 win 365
09:18:22.598292 IP 172.16.1.4.59520 > www.yandex.ru.www: F 1:1(0) ack 1 win 365
09:18:22.966909 IP www.yandex.ru.www > 172.16.1.4.59520: F 1:1(0) ack 2 win 28
09:18:22.966986 IP www.yandex.ru.www > 10.102.0.2.59520: F 1:1(0) ack 2 win 28
09:18:22.967432 IP 10.102.0.2.59520 > www.yandex.ru.www: . ack 2 win 365
09:18:22.967467 IP 172.16.1.4.59520 > www.yandex.ru.www: . ack 2 win 365
09:18:23.065615 IP www.yandex.ru.www > 172.16.1.4.59520: F 1:1(0) ack 2 win 28
09:18:23.065688 IP www.yandex.ru.www > 10.102.0.2.59520: F 1:1(0) ack 2 win 28
09:18:23.066204 IP 10.102.0.2.59520 > www.yandex.ru.www: . ack 2 win 365
09:18:23.066263 IP 172.16.1.4.59520 > www.yandex.ru.www: . ack 2 win 365
09:18:23.123164 IP www.yandex.ru.www > 172.16.1.4.59520: R 92206863:92206863(0) win 0
09:18:23.123228 IP www.yandex.ru.www > 10.102.0.2.59520: R 92206863:92206863(0) win 0
\end{Verbatim}

Выполним с него \textbf{telnet 217.69.139.90 143},  чтобы проверить, что не
происходит подключение к сервисам, например, imap.mail.ru на порту 143:
\begin{Verbatim}
pc21:~# telnet 217.69.139.90 143
Trying 217.69.139.90...
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:18:51.606887 IP 10.102.0.2.35001 > imap.mail.ru.imap2: S 1864700003:1864700003(0) win 5840 <mss 1460,sackOK,timestamp 589175 0,nop,wscale 4>
\end{Verbatim}

Выполним с хоста \textbf{pc21} \textbf{traceroute -n 10.0.1.1},  чтобы проверить,
что разрешен vpn:
\begin{Verbatim}
pc21:~# traceroute -n 10.0.1.1
traceroute to 10.0.1.1 (10.0.1.1), 64 hops max, 40 byte packets
 1  10.102.0.1  0 ms  0 ms  0 ms
 2  10.200.1.1  1 ms  1 ms  1 ms
 3  10.0.1.1  1 ms  1 ms  1 ms
\end{Verbatim}


\section{Проверка доступа к внутреннему серверу}

Проверим правильность найтройки правил фильтрации на маршрутизаторах
с использованием  telnet.

Для проверки доступа к \textbf{s12} выполним со своей машины
\textbf{telnet 172.16.1.3 80}:
\begin{Verbatim}
alex@alex-HP-Pavilion-dv5-Notebook-PC:~/np/lab4$ telnet 172.16.1.3 80
Trying 172.16.1.3...
Connected to 172.16.1.3.
Escape character is '^]'.
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:19:51.150758 IP 172.16.1.2.51137 > 172.16.1.3.www: S 1367411947:1367411947(0) win 14600 <mss 1460,sackOK,timestamp 1556835 0,nop,wscale 4>
09:19:51.177621 IP 172.16.1.2.51137 > 10.0.4.20.www: S 1367411947:1367411947(0) win 14600 <mss 1460,sackOK,timestamp 1556835 0,nop,wscale 4>
09:19:51.177952 IP 10.0.4.20.www > 172.16.1.2.51137: S 2782892952:2782892952(0) ack 1367411948 win 5792 <mss 1460,sackOK,timestamp 595099 1556835,nop,wscale 4>
09:19:51.177997 IP 172.16.1.3.www > 172.16.1.2.51137: S 2782892952:2782892952(0) ack 1367411948 win 5792 <mss 1460,sackOK,timestamp 595099 1556835,nop,wscale 4>
09:19:51.178497 IP 172.16.1.2.51137 > 172.16.1.3.www: . ack 1 win 913 <nop,nop,timestamp 1556842 595099>
09:19:51.178515 IP 172.16.1.2.51137 > 10.0.4.20.www: . ack 1 win 913 <nop,nop,timestamp 1556842 595099>
09:19:52.778474 IP 172.16.1.2.51137 > 172.16.1.3.www: F 1:1(0) ack 1 win 913 <nop,nop,timestamp 1557242 595099>
09:19:52.778547 IP 172.16.1.2.51137 > 10.0.4.20.www: F 1:1(0) ack 1 win 913 <nop,nop,timestamp 1557242 595099>
09:19:52.782967 IP 10.0.4.20.www > 172.16.1.2.51137: F 1:1(0) ack 2 win 362 <nop,nop,timestamp 595259 1557242>
09:19:52.783030 IP 172.16.1.3.www > 172.16.1.2.51137: F 1:1(0) ack 2 win 362 <nop,nop,timestamp 595259 1557242>
09:19:52.783335 IP 172.16.1.2.51137 > 172.16.1.3.www: . ack 2 win 913 <nop,nop,timestamp 1557243 595259>
09:19:52.783365 IP 172.16.1.2.51137 > 10.0.4.20.www: . ack 2 win 913 <nop,nop,timestamp 1557243 595259>
\end{Verbatim}

Для проверки доступа к \textbf{s11} выполним со своей машины
\textbf{telnet 172.16.1.3 25}:
\begin{Verbatim}
alex@alex-HP-Pavilion-dv5-Notebook-PC:~/np/lab4$ telnet 172.16.1.3 25
Trying 172.16.1.3...
Connected to 172.16.1.3.
Escape character is '^]'.
\end{Verbatim}

Вывод \textbf{tcpdump -i any -tnv -p tcp} на \textbf{r1}:
\begin{Verbatim}
09:20:17.450540 IP 172.16.1.2.48300 > 172.16.1.3.smtp: S 3219292845:3219292845(0) win 14600 <mss 1460,sackOK,timestamp 1563410 0,nop,wscale 4>
09:20:17.474141 IP 172.16.1.2.48300 > 10.0.4.10.smtp: S 3219292845:3219292845(0) win 14600 <mss 1460,sackOK,timestamp 1563410 0,nop,wscale 4>
09:20:17.474403 IP 10.0.4.10.smtp > 172.16.1.2.48300: S 3195829099:3195829099(0) ack 3219292846 win 5792 <mss 1460,sackOK,timestamp 597770 1563410,nop,wscale 4>
09:20:17.474434 IP 172.16.1.3.smtp > 172.16.1.2.48300: S 3195829099:3195829099(0) ack 3219292846 win 5792 <mss 1460,sackOK,timestamp 597770 1563410,nop,wscale 4>
09:20:17.474743 IP 172.16.1.2.48300 > 172.16.1.3.smtp: . ack 1 win 913 <nop,nop,timestamp 1563416 597770>
09:20:17.474760 IP 172.16.1.2.48300 > 10.0.4.10.smtp: . ack 1 win 913 <nop,nop,timestamp 1563416 597770>
09:20:17.492836 IP 10.0.4.10.54848 > 172.16.1.2.auth: S 3195555686:3195555686(0) win 5840 <mss 1460,sackOK,timestamp 597770 0,nop,wscale 4>
09:20:17.492877 IP 172.16.1.3.54848 > 172.16.1.2.auth: S 3195555686:3195555686(0) win 5840 <mss 1460,sackOK,timestamp 597770 0,nop,wscale 4>
09:20:17.493064 IP 172.16.1.2.auth > 172.16.1.3.54848: R 0:0(0) ack 3195555687 win 0
09:20:17.493098 IP 172.16.1.2.auth > 10.0.4.10.54848: R 0:0(0) ack 3195555687 win 0
09:20:19.376234 IP 172.16.1.2.48300 > 172.16.1.3.smtp: F 1:1(0) ack 1 win 913 <nop,nop,timestamp 1563891 597770>
09:20:19.376308 IP 172.16.1.2.48300 > 10.0.4.10.smtp: F 1:1(0) ack 1 win 913 <nop,nop,timestamp 1563891 597770>
09:20:19.396476 IP 10.0.4.10.smtp > 172.16.1.2.48300: . ack 2 win 362 <nop,nop,timestamp 597962 1563891>
09:20:19.396536 IP 172.16.1.3.smtp > 172.16.1.2.48300: . ack 2 win 362 <nop,nop,timestamp 597962 1563891>
\end{Verbatim}

\end{document}
